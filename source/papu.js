JSNES.PAPU=function(e){this.nes=e,this.square1=new JSNES.PAPU.ChannelSquare(this,!0),this.square2=new JSNES.PAPU.ChannelSquare(this,!1),this.triangle=new JSNES.PAPU.ChannelTriangle(this),this.noise=new JSNES.PAPU.ChannelNoise(this),this.dmc=new JSNES.PAPU.ChannelDM(this),this.frameIrqCounter=null,this.frameIrqCounterMax=4,this.initCounter=2048,this.channelEnableValue=null,this.bufferSize=8192,this.bufferIndex=0,this.sampleRate=44100,this.lengthLookup=null,this.dmcFreqLookup=null,this.noiseWavelengthLookup=null,this.square_table=null,this.tnd_table=null,this.sampleBuffer=new Array(2*this.bufferSize),this.frameIrqEnabled=!1,this.frameIrqActive=null,this.frameClockNow=null,this.startedPlaying=!1,this.recordOutput=!1,this.initingHardware=!1,this.masterFrameCounter=null,this.derivedFrameCounter=null,this.countSequence=null,this.sampleTimer=null,this.frameTime=null,this.sampleTimerMax=null,this.sampleCount=null,this.triValue=0,this.smpSquare1=null,this.smpSquare2=null,this.smpTriangle=null,this.smpDmc=null,this.accCount=null,this.prevSampleL=0,this.prevSampleR=0,this.smpAccumL=0,this.smpAccumR=0,this.dacRange=0,this.dcValue=0,this.masterVolume=256,this.stereoPosLSquare1=null,this.stereoPosLSquare2=null,this.stereoPosLTriangle=null,this.stereoPosLNoise=null,this.stereoPosLDMC=null,this.stereoPosRSquare1=null,this.stereoPosRSquare2=null,this.stereoPosRTriangle=null,this.stereoPosRNoise=null,this.stereoPosRDMC=null,this.extraCycles=null,this.maxSample=null,this.minSample=null,this.panning=[80,170,100,150,128],this.setPanning(this.panning),this.initLengthLookup(),this.initDmcFrequencyLookup(),this.initNoiseWavelengthLookup(),this.initDACtables();for(var t=0;t<20;t++)16===t?this.writeReg(16400,16):this.writeReg(16384+t,0);this.reset()},JSNES.PAPU.prototype={reset:function(){this.sampleRate=this.nes.opts.sampleRate,this.sampleTimerMax=Math.floor(1024*this.nes.opts.CPU_FREQ_NTSC*this.nes.opts.preferredFrameRate/(60*this.sampleRate)),this.frameTime=Math.floor(14915*this.nes.opts.preferredFrameRate/60),this.sampleTimer=0,this.bufferIndex=0,this.updateChannelEnable(0),this.masterFrameCounter=0,this.derivedFrameCounter=0,this.countSequence=0,this.sampleCount=0,this.initCounter=2048,this.frameIrqEnabled=!1,this.initingHardware=!1,this.resetCounter(),this.square1.reset(),this.square2.reset(),this.triangle.reset(),this.noise.reset(),this.dmc.reset(),this.bufferIndex=0,this.accCount=0,this.smpSquare1=0,this.smpSquare2=0,this.smpTriangle=0,this.smpDmc=0,this.frameIrqEnabled=!1,this.frameIrqCounterMax=4,this.channelEnableValue=255,this.startedPlaying=!1,this.prevSampleL=0,this.prevSampleR=0,this.smpAccumL=0,this.smpAccumR=0,this.maxSample=-5e5,this.minSample=5e5},readReg:function(e){var t=0;return t|=this.square1.getLengthStatus(),t|=this.square2.getLengthStatus()<<1,t|=this.triangle.getLengthStatus()<<2,t|=this.noise.getLengthStatus()<<3,t|=this.dmc.getLengthStatus()<<4,t|=(this.frameIrqActive&&this.frameIrqEnabled?1:0)<<6,t|=this.dmc.getIrqStatus()<<7,this.frameIrqActive=!1,this.dmc.irqGenerated=!1,65535&t},writeReg:function(e,t){e>=16384&&e<16388?this.square1.writeReg(e,t):e>=16388&&e<16392?this.square2.writeReg(e,t):e>=16392&&e<16396?this.triangle.writeReg(e,t):e>=16396&&e<=16399?this.noise.writeReg(e,t):16400===e||16401===e||16402===e||16403===e?this.dmc.writeReg(e,t):16405===e?(this.updateChannelEnable(t),0!==t&&this.initCounter>0&&(this.initingHardware=!0),this.dmc.writeReg(e,t)):16407===e&&(this.countSequence=t>>7&1,this.masterFrameCounter=0,this.frameIrqActive=!1,this.frameIrqEnabled=!(t>>6&1),0===this.countSequence?(this.frameIrqCounterMax=4,this.derivedFrameCounter=4):(this.frameIrqCounterMax=5,this.derivedFrameCounter=0,this.frameCounterTick()))},resetCounter:function(){0===this.countSequence?this.derivedFrameCounter=4:this.derivedFrameCounter=0},updateChannelEnable:function(e){this.channelEnableValue=65535&e,this.square1.setEnabled(!!(1&e)),this.square2.setEnabled(!!(2&e)),this.triangle.setEnabled(!!(4&e)),this.noise.setEnabled(!!(8&e)),this.dmc.setEnabled(!!(16&e))},clockFrameCounter:function(e){if(this.initCounter>0&&this.initingHardware)return this.initCounter-=e,void(this.initCounter<=0&&(this.initingHardware=!1));e+=this.extraCycles;var t=this.sampleTimerMax-this.sampleTimer;e<<10>t?(this.extraCycles=(e<<10)-t>>10,e-=this.extraCycles):this.extraCycles=0;var s=this.dmc,i=this.triangle,h=this.square1,n=this.square2,a=this.noise;if(s.isEnabled)for(s.shiftCounter-=e<<3;s.shiftCounter<=0&&s.dmaFrequency>0;)s.shiftCounter+=s.dmaFrequency,s.clockDmc();if(i.progTimerMax>0)for(i.progTimerCount-=e;i.progTimerCount<=0;)i.progTimerCount+=i.progTimerMax+1,i.linearCounter>0&&i.lengthCounter>0&&(i.triangleCounter++,i.triangleCounter&=31,i.isEnabled&&(i.triangleCounter>=16?i.sampleValue=15&i.triangleCounter:i.sampleValue=15-(15&i.triangleCounter),i.sampleValue<<=4));h.progTimerCount-=e,h.progTimerCount<=0&&(h.progTimerCount+=h.progTimerMax+1<<1,h.squareCounter++,h.squareCounter&=7,h.updateSampleValue()),n.progTimerCount-=e,n.progTimerCount<=0&&(n.progTimerCount+=n.progTimerMax+1<<1,n.squareCounter++,n.squareCounter&=7,n.updateSampleValue());var r=e;if(a.progTimerCount-r>0)a.progTimerCount-=r,a.accCount+=r,a.accValue+=r*a.sampleValue;else for(;r-- >0;)--a.progTimerCount<=0&&a.progTimerMax>0&&(a.shiftReg<<=1,a.tmp=32768&(a.shiftReg<<(0===a.randomMode?1:6)^a.shiftReg),0!==a.tmp?(a.shiftReg|=1,a.randomBit=0,a.sampleValue=0):(a.randomBit=1,a.isEnabled&&a.lengthCounter>0?a.sampleValue=a.masterVolume:a.sampleValue=0),a.progTimerCount+=a.progTimerMax),a.accValue+=a.sampleValue,a.accCount++;this.frameIrqEnabled&&this.frameIrqActive&&this.nes.cpu.requestIrq(this.nes.cpu.IRQ_NORMAL),this.masterFrameCounter+=e<<1,this.masterFrameCounter>=this.frameTime&&(this.masterFrameCounter-=this.frameTime,this.frameCounterTick()),this.accSample(e),this.sampleTimer+=e<<10,this.sampleTimer>=this.sampleTimerMax&&(this.sample(),this.sampleTimer-=this.sampleTimerMax)},accSample:function(e){this.triangle.sampleCondition&&(this.triValue=Math.floor((this.triangle.progTimerCount<<4)/(this.triangle.progTimerMax+1)),this.triValue>16&&(this.triValue=16),this.triangle.triangleCounter>=16&&(this.triValue=16-this.triValue),this.triValue+=this.triangle.sampleValue),2===e?(this.smpTriangle+=this.triValue<<1,this.smpDmc+=this.dmc.sample<<1,this.smpSquare1+=this.square1.sampleValue<<1,this.smpSquare2+=this.square2.sampleValue<<1,this.accCount+=2):4===e?(this.smpTriangle+=this.triValue<<2,this.smpDmc+=this.dmc.sample<<2,this.smpSquare1+=this.square1.sampleValue<<2,this.smpSquare2+=this.square2.sampleValue<<2,this.accCount+=4):(this.smpTriangle+=e*this.triValue,this.smpDmc+=e*this.dmc.sample,this.smpSquare1+=e*this.square1.sampleValue,this.smpSquare2+=e*this.square2.sampleValue,this.accCount+=e)},frameCounterTick:function(){this.derivedFrameCounter++,this.derivedFrameCounter>=this.frameIrqCounterMax&&(this.derivedFrameCounter=0),1!==this.derivedFrameCounter&&3!==this.derivedFrameCounter||(this.triangle.clockLengthCounter(),this.square1.clockLengthCounter(),this.square2.clockLengthCounter(),this.noise.clockLengthCounter(),this.square1.clockSweep(),this.square2.clockSweep()),this.derivedFrameCounter>=0&&this.derivedFrameCounter<4&&(this.square1.clockEnvDecay(),this.square2.clockEnvDecay(),this.noise.clockEnvDecay(),this.triangle.clockLinearCounter()),3===this.derivedFrameCounter&&0===this.countSequence&&(this.frameIrqActive=!0)},sample:function(){var e,t;this.accCount>0?(this.smpSquare1<<=4,this.smpSquare1=Math.floor(this.smpSquare1/this.accCount),this.smpSquare2<<=4,this.smpSquare2=Math.floor(this.smpSquare2/this.accCount),this.smpTriangle=Math.floor(this.smpTriangle/this.accCount),this.smpDmc<<=4,this.smpDmc=Math.floor(this.smpDmc/this.accCount),this.accCount=0):(this.smpSquare1=this.square1.sampleValue<<4,this.smpSquare2=this.square2.sampleValue<<4,this.smpTriangle=this.triangle.sampleValue,this.smpDmc=this.dmc.sample<<4);var s=Math.floor((this.noise.accValue<<4)/this.noise.accCount);this.noise.accValue=s>>4,this.noise.accCount=1,e=this.smpSquare1*this.stereoPosLSquare1+this.smpSquare2*this.stereoPosLSquare2>>8,t=3*this.smpTriangle*this.stereoPosLTriangle+(s<<1)*this.stereoPosLNoise+this.smpDmc*this.stereoPosLDMC>>8,e>=this.square_table.length&&(e=this.square_table.length-1),t>=this.tnd_table.length&&(t=this.tnd_table.length-1);var i=this.square_table[e]+this.tnd_table[t]-this.dcValue;e=this.smpSquare1*this.stereoPosRSquare1+this.smpSquare2*this.stereoPosRSquare2>>8,t=3*this.smpTriangle*this.stereoPosRTriangle+(s<<1)*this.stereoPosRNoise+this.smpDmc*this.stereoPosRDMC>>8,e>=this.square_table.length&&(e=this.square_table.length-1),t>=this.tnd_table.length&&(t=this.tnd_table.length-1);var h=this.square_table[e]+this.tnd_table[t]-this.dcValue,n=i-this.prevSampleL;this.prevSampleL+=n,this.smpAccumL+=n-(this.smpAccumL>>10),i=this.smpAccumL;var a=h-this.prevSampleR;this.prevSampleR+=a,this.smpAccumR+=a-(this.smpAccumR>>10),h=this.smpAccumR,i>this.maxSample&&(this.maxSample=i),i<this.minSample&&(this.minSample=i),this.sampleBuffer[this.bufferIndex++]=i,this.sampleBuffer[this.bufferIndex++]=h,this.bufferIndex===this.sampleBuffer.length&&(this.nes.ui.writeAudio(this.sampleBuffer),this.sampleBuffer=new Array(2*this.bufferSize),this.bufferIndex=0),this.smpSquare1=0,this.smpSquare2=0,this.smpTriangle=0,this.smpDmc=0},getLengthMax:function(e){return this.lengthLookup[e>>3]},getDmcFrequency:function(e){return e>=0&&e<16?this.dmcFreqLookup[e]:0},getNoiseWaveLength:function(e){return e>=0&&e<16?this.noiseWavelengthLookup[e]:0},setPanning:function(e){for(var t=0;t<5;t++)this.panning[t]=e[t];this.updateStereoPos()},setMasterVolume:function(e){e<0&&(e=0),e>256&&(e=256),this.masterVolume=e,this.updateStereoPos()},updateStereoPos:function(){this.stereoPosLSquare1=this.panning[0]*this.masterVolume>>8,this.stereoPosLSquare2=this.panning[1]*this.masterVolume>>8,this.stereoPosLTriangle=this.panning[2]*this.masterVolume>>8,this.stereoPosLNoise=this.panning[3]*this.masterVolume>>8,this.stereoPosLDMC=this.panning[4]*this.masterVolume>>8,this.stereoPosRSquare1=this.masterVolume-this.stereoPosLSquare1,this.stereoPosRSquare2=this.masterVolume-this.stereoPosLSquare2,this.stereoPosRTriangle=this.masterVolume-this.stereoPosLTriangle,this.stereoPosRNoise=this.masterVolume-this.stereoPosLNoise,this.stereoPosRDMC=this.masterVolume-this.stereoPosLDMC},initLengthLookup:function(){this.lengthLookup=[10,254,20,2,40,4,80,6,160,8,60,10,14,12,26,14,12,16,24,18,48,20,96,22,192,24,72,26,16,28,32,30]},initDmcFrequencyLookup:function(){this.dmcFreqLookup=new Array(16),this.dmcFreqLookup[0]=3424,this.dmcFreqLookup[1]=3040,this.dmcFreqLookup[2]=2720,this.dmcFreqLookup[3]=2560,this.dmcFreqLookup[4]=2288,this.dmcFreqLookup[5]=2032,this.dmcFreqLookup[6]=1808,this.dmcFreqLookup[7]=1712,this.dmcFreqLookup[8]=1520,this.dmcFreqLookup[9]=1280,this.dmcFreqLookup[10]=1136,this.dmcFreqLookup[11]=1024,this.dmcFreqLookup[12]=848,this.dmcFreqLookup[13]=672,this.dmcFreqLookup[14]=576,this.dmcFreqLookup[15]=432},initNoiseWavelengthLookup:function(){this.noiseWavelengthLookup=new Array(16),this.noiseWavelengthLookup[0]=4,this.noiseWavelengthLookup[1]=8,this.noiseWavelengthLookup[2]=16,this.noiseWavelengthLookup[3]=32,this.noiseWavelengthLookup[4]=64,this.noiseWavelengthLookup[5]=96,this.noiseWavelengthLookup[6]=128,this.noiseWavelengthLookup[7]=160,this.noiseWavelengthLookup[8]=202,this.noiseWavelengthLookup[9]=254,this.noiseWavelengthLookup[10]=380,this.noiseWavelengthLookup[11]=508,this.noiseWavelengthLookup[12]=762,this.noiseWavelengthLookup[13]=1016,this.noiseWavelengthLookup[14]=2034,this.noiseWavelengthLookup[15]=4068},initDACtables:function(){var e,t,s,i=0,h=0;for(this.square_table=new Array(512),this.tnd_table=new Array(3264),s=0;s<512;s++)e=95.52/(8128/(s/16)+100),e*=.98411,e*=5e4,t=Math.floor(e),this.square_table[s]=t,t>i&&(i=t);for(s=0;s<3264;s++)e=163.67/(24329/(s/16)+100),e*=.98411,e*=5e4,t=Math.floor(e),this.tnd_table[s]=t,t>h&&(h=t);this.dacRange=i+h,this.dcValue=this.dacRange/2}},JSNES.PAPU.ChannelDM=function(e){this.papu=e,this.MODE_NORMAL=0,this.MODE_LOOP=1,this.MODE_IRQ=2,this.isEnabled=null,this.hasSample=null,this.irqGenerated=!1,this.playMode=null,this.dmaFrequency=null,this.dmaCounter=null,this.deltaCounter=null,this.playStartAddress=null,this.playAddress=null,this.playLength=null,this.playLengthCounter=null,this.shiftCounter=null,this.reg4012=null,this.reg4013=null,this.sample=null,this.dacLsb=null,this.data=null,this.reset()},JSNES.PAPU.ChannelDM.prototype={clockDmc:function(){this.hasSample&&(1&this.data?this.deltaCounter<63&&this.deltaCounter++:this.deltaCounter>0&&this.deltaCounter--,this.sample=this.isEnabled?(this.deltaCounter<<1)+this.dacLsb:0,this.data>>=1),this.dmaCounter--,this.dmaCounter<=0&&(this.hasSample=!1,this.endOfSample(),this.dmaCounter=8),this.irqGenerated&&this.papu.nes.cpu.requestIrq(this.papu.nes.cpu.IRQ_NORMAL)},endOfSample:function(){0===this.playLengthCounter&&this.playMode===this.MODE_LOOP&&(this.playAddress=this.playStartAddress,this.playLengthCounter=this.playLength),this.playLengthCounter>0&&(this.nextSample(),0===this.playLengthCounter&&this.playMode===this.MODE_IRQ&&(this.irqGenerated=!0))},nextSample:function(){this.data=this.papu.nes.mmap.load(this.playAddress),this.papu.nes.cpu.haltCycles(4),this.playLengthCounter--,this.playAddress++,this.playAddress>65535&&(this.playAddress=32768),this.hasSample=!0},writeReg:function(e,t){16400===e?(t>>6?1==(t>>6&1)?this.playMode=this.MODE_LOOP:t>>6==2&&(this.playMode=this.MODE_IRQ):this.playMode=this.MODE_NORMAL,128&t||(this.irqGenerated=!1),this.dmaFrequency=this.papu.getDmcFrequency(15&t)):16401===e?(this.deltaCounter=t>>1&63,this.dacLsb=1&t,this.sample=(this.deltaCounter<<1)+this.dacLsb):16402===e?(this.playStartAddress=t<<6|49152,this.playAddress=this.playStartAddress,this.reg4012=t):16403===e?(this.playLength=1+(t<<4),this.playLengthCounter=this.playLength,this.reg4013=t):16405===e&&(t>>4&1?(this.playAddress=this.playStartAddress,this.playLengthCounter=this.playLength):this.playLengthCounter=0,this.irqGenerated=!1)},setEnabled:function(e){!this.isEnabled&&e&&(this.playLengthCounter=this.playLength),this.isEnabled=e},getLengthStatus:function(){return 0!==this.playLengthCounter&&this.isEnabled?1:0},getIrqStatus:function(){return this.irqGenerated?1:0},reset:function(){this.isEnabled=!1,this.irqGenerated=!1,this.playMode=this.MODE_NORMAL,this.dmaFrequency=0,this.dmaCounter=0,this.deltaCounter=0,this.playStartAddress=0,this.playAddress=0,this.playLength=0,this.playLengthCounter=0,this.sample=0,this.dacLsb=0,this.shiftCounter=0,this.reg4012=0,this.reg4013=0,this.data=0}},JSNES.PAPU.ChannelNoise=function(e){this.papu=e,this.isEnabled=null,this.envDecayDisable=null,this.envDecayLoopEnable=null,this.lengthCounterEnable=null,this.envReset=null,this.shiftNow=null,this.lengthCounter=null,this.progTimerCount=null,this.progTimerMax=null,this.envDecayRate=null,this.envDecayCounter=null,this.envVolume=null,this.masterVolume=null,this.shiftReg=16384,this.randomBit=null,this.randomMode=null,this.sampleValue=null,this.accValue=0,this.accCount=1,this.tmp=null,this.reset()},JSNES.PAPU.ChannelNoise.prototype={reset:function(){this.progTimerCount=0,this.progTimerMax=0,this.isEnabled=!1,this.lengthCounter=0,this.lengthCounterEnable=!1,this.envDecayDisable=!1,this.envDecayLoopEnable=!1,this.shiftNow=!1,this.envDecayRate=0,this.envDecayCounter=0,this.envVolume=0,this.masterVolume=0,this.shiftReg=1,this.randomBit=0,this.randomMode=0,this.sampleValue=0,this.tmp=0},clockLengthCounter:function(){this.lengthCounterEnable&&this.lengthCounter>0&&(this.lengthCounter--,0===this.lengthCounter&&this.updateSampleValue())},clockEnvDecay:function(){this.envReset?(this.envReset=!1,this.envDecayCounter=this.envDecayRate+1,this.envVolume=15):--this.envDecayCounter<=0&&(this.envDecayCounter=this.envDecayRate+1,this.envVolume>0?this.envVolume--:this.envVolume=this.envDecayLoopEnable?15:0),this.masterVolume=this.envDecayDisable?this.envDecayRate:this.envVolume,this.updateSampleValue()},updateSampleValue:function(){this.isEnabled&&this.lengthCounter>0&&(this.sampleValue=this.randomBit*this.masterVolume)},writeReg:function(e,t){16396===e?(this.envDecayDisable=!!(16&t),this.envDecayRate=15&t,this.envDecayLoopEnable=!!(32&t),this.lengthCounterEnable=!(32&t),this.masterVolume=this.envDecayDisable?this.envDecayRate:this.envVolume):16398===e?(this.progTimerMax=this.papu.getNoiseWaveLength(15&t),this.randomMode=t>>7):16399===e&&(this.lengthCounter=this.papu.getLengthMax(248&t),this.envReset=!0)},setEnabled:function(e){this.isEnabled=e,e||(this.lengthCounter=0),this.updateSampleValue()},getLengthStatus:function(){return 0!==this.lengthCounter&&this.isEnabled?1:0}},JSNES.PAPU.ChannelSquare=function(e,t){this.papu=e,this.dutyLookup=[0,1,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,1,1,1,1,0,0,0,1,0,0,1,1,1,1,1],this.impLookup=[1,-1,0,0,0,0,0,0,1,0,-1,0,0,0,0,0,1,0,0,0,-1,0,0,0,-1,0,1,0,0,0,0,0],this.sqr1=t,this.isEnabled=null,this.lengthCounterEnable=null,this.sweepActive=null,this.envDecayDisable=null,this.envDecayLoopEnable=null,this.envReset=null,this.sweepCarry=null,this.updateSweepPeriod=null,this.progTimerCount=null,this.progTimerMax=null,this.lengthCounter=null,this.squareCounter=null,this.sweepCounter=null,this.sweepCounterMax=null,this.sweepMode=null,this.sweepShiftAmount=null,this.envDecayRate=null,this.envDecayCounter=null,this.envVolume=null,this.masterVolume=null,this.dutyMode=null,this.sweepResult=null,this.sampleValue=null,this.vol=null,this.reset()},JSNES.PAPU.ChannelSquare.prototype={reset:function(){this.progTimerCount=0,this.progTimerMax=0,this.lengthCounter=0,this.squareCounter=0,this.sweepCounter=0,this.sweepCounterMax=0,this.sweepMode=0,this.sweepShiftAmount=0,this.envDecayRate=0,this.envDecayCounter=0,this.envVolume=0,this.masterVolume=0,this.dutyMode=0,this.vol=0,this.isEnabled=!1,this.lengthCounterEnable=!1,this.sweepActive=!1,this.sweepCarry=!1,this.envDecayDisable=!1,this.envDecayLoopEnable=!1},clockLengthCounter:function(){this.lengthCounterEnable&&this.lengthCounter>0&&(this.lengthCounter--,0===this.lengthCounter&&this.updateSampleValue())},clockEnvDecay:function(){this.envReset?(this.envReset=!1,this.envDecayCounter=this.envDecayRate+1,this.envVolume=15):--this.envDecayCounter<=0&&(this.envDecayCounter=this.envDecayRate+1,this.envVolume>0?this.envVolume--:this.envVolume=this.envDecayLoopEnable?15:0),this.masterVolume=this.envDecayDisable?this.envDecayRate:this.envVolume,this.updateSampleValue()},clockSweep:function(){--this.sweepCounter<=0&&(this.sweepCounter=this.sweepCounterMax+1,this.sweepActive&&this.sweepShiftAmount>0&&this.progTimerMax>7&&(this.sweepCarry=!1,0===this.sweepMode?(this.progTimerMax+=this.progTimerMax>>this.sweepShiftAmount,this.progTimerMax>4095&&(this.progTimerMax=4095,this.sweepCarry=!0)):this.progTimerMax=this.progTimerMax-((this.progTimerMax>>this.sweepShiftAmount)-(this.sqr1?1:0)))),this.updateSweepPeriod&&(this.updateSweepPeriod=!1,this.sweepCounter=this.sweepCounterMax+1)},updateSampleValue:function(){this.isEnabled&&this.lengthCounter>0&&this.progTimerMax>7?0===this.sweepMode&&this.progTimerMax+(this.progTimerMax>>this.sweepShiftAmount)>4095?this.sampleValue=0:this.sampleValue=this.masterVolume*this.dutyLookup[(this.dutyMode<<3)+this.squareCounter]:this.sampleValue=0},writeReg:function(e,t){var s=this.sqr1?0:4;e===16384+s?(this.envDecayDisable=!!(16&t),this.envDecayRate=15&t,this.envDecayLoopEnable=!!(32&t),this.dutyMode=t>>6&3,this.lengthCounterEnable=!(32&t),this.masterVolume=this.envDecayDisable?this.envDecayRate:this.envVolume,this.updateSampleValue()):e===16385+s?(this.sweepActive=!!(128&t),this.sweepCounterMax=t>>4&7,this.sweepMode=t>>3&1,this.sweepShiftAmount=7&t,this.updateSweepPeriod=!0):e===16386+s?(this.progTimerMax&=1792,this.progTimerMax|=t):e===16387+s&&(this.progTimerMax&=255,this.progTimerMax|=(7&t)<<8,this.isEnabled&&(this.lengthCounter=this.papu.getLengthMax(248&t)),this.envReset=!0)},setEnabled:function(e){this.isEnabled=e,e||(this.lengthCounter=0),this.updateSampleValue()},getLengthStatus:function(){return 0!==this.lengthCounter&&this.isEnabled?1:0}},JSNES.PAPU.ChannelTriangle=function(e){this.papu=e,this.isEnabled=null,this.sampleCondition=null,this.lengthCounterEnable=null,this.lcHalt=null,this.lcControl=null,this.progTimerCount=null,this.progTimerMax=null,this.triangleCounter=null,this.lengthCounter=null,this.linearCounter=null,this.lcLoadValue=null,this.sampleValue=null,this.tmp=null,this.reset()},JSNES.PAPU.ChannelTriangle.prototype={reset:function(){this.progTimerCount=0,this.progTimerMax=0,this.triangleCounter=0,this.isEnabled=!1,this.sampleCondition=!1,this.lengthCounter=0,this.lengthCounterEnable=!1,this.linearCounter=0,this.lcLoadValue=0,this.lcHalt=!0,this.lcControl=!1,this.tmp=0,this.sampleValue=15},clockLengthCounter:function(){this.lengthCounterEnable&&this.lengthCounter>0&&(this.lengthCounter--,0===this.lengthCounter&&this.updateSampleCondition())},clockLinearCounter:function(){this.lcHalt?(this.linearCounter=this.lcLoadValue,this.updateSampleCondition()):this.linearCounter>0&&(this.linearCounter--,this.updateSampleCondition()),this.lcControl||(this.lcHalt=!1)},getLengthStatus:function(){return 0!==this.lengthCounter&&this.isEnabled?1:0},readReg:function(e){return 0},writeReg:function(e,t){16392===e?(this.lcControl=!!(128&t),this.lcLoadValue=127&t,this.lengthCounterEnable=!this.lcControl):16394===e?(this.progTimerMax&=1792,this.progTimerMax|=t):16395===e&&(this.progTimerMax&=255,this.progTimerMax|=(7&t)<<8,this.lengthCounter=this.papu.getLengthMax(248&t),this.lcHalt=!0),this.updateSampleCondition()},clockProgrammableTimer:function(e){if(this.progTimerMax>0)for(this.progTimerCount+=e;this.progTimerMax>0&&this.progTimerCount>=this.progTimerMax;)this.progTimerCount-=this.progTimerMax,this.isEnabled&&this.lengthCounter>0&&this.linearCounter>0&&this.clockTriangleGenerator()},clockTriangleGenerator:function(){this.triangleCounter++,this.triangleCounter&=31},setEnabled:function(e){this.isEnabled=e,e||(this.lengthCounter=0),this.updateSampleCondition()},updateSampleCondition:function(){this.sampleCondition=this.isEnabled&&this.progTimerMax>7&&this.linearCounter>0&&this.lengthCounter>0}};